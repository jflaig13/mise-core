{% extends "base.html" %}

{% block title %}Record {{ shifty.label }}{% endblock %}
{% block header_right %}{{ shifty.day }}{% endblock %}

{% block content %}
<div class="p-4">
    <!-- Header -->
    <div class="mb-8 text-center">
        <h1 class="text-2xl font-bold mb-1">{{ shifty.label }}</h1>
        <p class="text-gray-400">{{ shifty_date }} - {{ pay_period }}</p>
    </div>

    <!-- Recording UI -->
    <div id="recorder" class="text-center py-8">
        <button id="record-btn"
                class="w-36 h-36 rounded-full bg-red-600 hover:bg-red-700 text-white text-lg font-semibold
                       transition-all duration-200 active:scale-95 shadow-lg"
                onclick="toggleRecording()">
            <span id="btn-text">Tap to<br>Record</span>
        </button>
        <p id="status" class="mt-6 text-gray-400">Tap the button to start recording</p>
        <p id="timer" class="mt-2 text-2xl font-mono text-gray-500 hidden">00:00</p>
    </div>

    <!-- Or upload -->
    <div class="mt-8 text-center">
        <div class="relative inline-block">
            <p class="text-gray-500 mb-3">Or upload existing recording:</p>
            <label class="inline-block px-6 py-3 bg-gray-800 hover:bg-gray-700 rounded-lg cursor-pointer transition-colors">
                <span class="text-sm">Choose File</span>
                <input type="file" accept="audio/*,.wav,.m4a,.mp3"
                       class="hidden" onchange="uploadFile(this)">
            </label>
        </div>
    </div>

    <!-- Processing overlay -->
    <div id="processing-overlay" class="hidden fixed inset-0 bg-gray-900/95 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-xl font-semibold mb-2">Processing...</p>
            <p class="text-gray-400" id="processing-status">Transcribing audio</p>
        </div>
    </div>

    <!-- Error message -->
    <div id="error-message" class="hidden mt-6 p-4 bg-red-900/50 border border-red-700 rounded-lg">
        <p class="text-red-400" id="error-text"></p>
        <button onclick="document.getElementById('error-message').classList.add('hidden')"
                class="mt-2 text-sm text-gray-400 hover:text-white">Dismiss</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let mediaRecorder;
let chunks = [];
let timerInterval;
let seconds = 0;

function updateTimer() {
    seconds++;
    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
    const secs = (seconds % 60).toString().padStart(2, '0');
    document.getElementById('timer').textContent = `${mins}:${secs}`;
}

async function toggleRecording() {
    const btn = document.getElementById('record-btn');
    const btnText = document.getElementById('btn-text');
    const status = document.getElementById('status');
    const timer = document.getElementById('timer');

    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        // Start recording
        try {
            const stream = await navigator.mediaDevices.getUserMedia({audio: true});
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];

            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, {type: 'audio/webm'});
                submitAudio(blob);
            };

            mediaRecorder.start();
            btn.classList.add('recording', 'bg-red-500');
            btnText.innerHTML = 'Tap to<br>Stop';
            status.textContent = 'Recording...';
            timer.classList.remove('hidden');
            seconds = 0;
            timerInterval = setInterval(updateTimer, 1000);

        } catch (err) {
            showError('Microphone access denied. Please allow microphone access and try again.');
        }
    } else {
        // Stop recording
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        btn.classList.remove('recording', 'bg-red-500');
        btnText.innerHTML = '‚è≥';
        status.textContent = 'Processing...';
        clearInterval(timerInterval);
    }
}

function uploadFile(input) {
    if (input.files[0]) {
        const file = input.files[0];
        document.getElementById('status').textContent = `Uploading ${file.name}...`;
        submitAudio(file);
    }
}

async function submitAudio(audioBlob) {
    const overlay = document.getElementById('processing-overlay');
    const processingStatus = document.getElementById('processing-status');

    overlay.classList.remove('hidden');
    processingStatus.textContent = 'Uploading audio...';

    const formData = new FormData();
    formData.append('file', audioBlob, '{{ shifty.code }}.wav');

    try {
        processingStatus.textContent = 'Transcribing audio...';

        const response = await fetch('/process/{{ shifty.code }}', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.status === 'success') {
            processingStatus.textContent = 'Opening approval sheet...';

            if (result.sheet_url) {
                // Redirect to Google Sheet for approval
                window.location.href = result.sheet_url;
            } else {
                // No sheet configured - show success and go home
                overlay.classList.add('hidden');
                alert('Processed successfully! (No Google Sheet configured)');
                window.location.href = '/';
            }
        } else {
            overlay.classList.add('hidden');
            showError(result.error || 'Processing failed');
            resetRecordButton();
        }

    } catch (err) {
        overlay.classList.add('hidden');
        showError('Network error: ' + err.message);
        resetRecordButton();
    }
}

function showError(message) {
    const errorDiv = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    errorText.textContent = message;
    errorDiv.classList.remove('hidden');
}

function resetRecordButton() {
    const btn = document.getElementById('record-btn');
    const btnText = document.getElementById('btn-text');
    const status = document.getElementById('status');
    const timer = document.getElementById('timer');

    btn.classList.remove('recording', 'bg-red-500');
    btnText.innerHTML = 'Tap to<br>Record';
    status.textContent = 'Tap the button to start recording';
    timer.classList.add('hidden');
    clearInterval(timerInterval);
}
</script>
{% endblock %}
