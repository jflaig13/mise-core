{% extends "base_inventory.html" %}

{% block title %}Approve Shelfy{% endblock %}

{% block content %}
<div class="p-4">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-mise-navy">Review & Approve</h1>
        <div class="flex items-center mt-2 text-mise-navy/60">
            <span class="px-2 py-1 bg-mise-red/10 rounded text-sm mr-2">{{ shelfy.category | capitalize }}</span>
            <span class="text-lg font-medium">{{ shelfy.area }}</span>
        </div>
        <p class="text-sm text-mise-navy/40 mt-1">{{ shelfy.period_id }}</p>
    </div>

    <!-- Parsed Items (if available) -->
    {% if shelfy.inventory_json and shelfy.inventory_json['items'] %}
    <div class="mise-card rounded-xl p-4 mb-6">
        <h2 class="text-sm font-semibold text-mise-navy/60 mb-3">üì¶ Parsed Inventory</h2>
        <div class="space-y-2 max-h-96 overflow-y-auto">
            {% for item in shelfy.inventory_json['items'] %}
            {# Flag for review if: explicitly marked, OR confidence < 0.8, OR legacy item (no confidence field) #}
            {% set show_review = item.needs_review == true or (item.confidence is defined and item.confidence < 0.8) or (item.confidence is not defined and item.user_confirmed != true) %}
            <div class="p-3 rounded-lg {% if show_review %}bg-yellow-50 border border-yellow-300{% else %}bg-green-50{% endif %}"
                 id="item-{{ loop.index0 }}">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center">
                            {% if show_review %}
                            <span class="text-yellow-600 mr-2" title="Needs review">‚ùì</span>
                            {% endif %}
                            <span class="font-semibold text-mise-navy item-product-name">{{ item.product_name }}</span>
                        </div>
                        {% if item.notes %}
                        <div class="text-xs text-mise-navy/50 italic mt-1">{{ item.notes }}</div>
                        {% endif %}

                        <!-- Review UI for uncertain matches -->
                        {% if show_review %}
                        <div class="mt-2 p-2 bg-yellow-100 rounded border border-yellow-200 review-panel">
                            {% if item.spoken_name %}
                            <div class="text-xs text-yellow-800 mb-1">
                                <span class="font-semibold">Heard:</span> "{{ item.spoken_name }}"
                            </div>
                            {% endif %}
                            {% if item.confidence is defined %}
                            <div class="text-xs text-yellow-800 mb-2">
                                <span class="font-semibold">Confidence:</span>
                                <span class="{% if item.confidence >= 0.7 %}text-green-700{% elif item.confidence >= 0.5 %}text-yellow-700{% else %}text-red-700{% endif %}">
                                    {{ (item.confidence * 100)|int }}%
                                </span>
                            </div>
                            {% else %}
                            <div class="text-xs text-yellow-800 mb-2">
                                <span class="font-semibold">Status:</span> <span class="text-yellow-700">Unverified</span>
                            </div>
                            {% endif %}
                            <button type="button"
                                    onclick="acceptMatch({{ loop.index0 }}, '{{ shelfy.shelfy_id }}', '{{ item.product_name|e }}')"
                                    class="text-xs px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded font-medium transition-colors">
                                ‚úì Confirm Match
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    <div class="text-right ml-4">
                        <div class="font-bold text-mise-navy">
                            {% if item.quantity %}{{ item.quantity }}{% else %}‚Äî{% endif %}
                            <span class="text-sm font-normal text-mise-navy/60">{{ item.unit }}</span>
                        </div>
                        {% if item.conversion_display %}
                        <div class="text-xs text-mise-navy/50 mt-1">
                            ({{ item.conversion_display }})
                        </div>
                        {% endif %}
                        {% if item.confidence is defined and not show_review %}
                        <div class="text-xs text-green-600 mt-1">
                            {{ (item.confidence * 100)|int }}% match
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Transcript Box -->
    <div class="mise-card mise-accent-left-red rounded-xl p-4 mb-6">
        <h2 class="text-sm font-semibold text-mise-navy/60 mb-3">Transcript</h2>
        <div class="text-mise-navy leading-relaxed max-h-64 overflow-y-auto">
            {{ shelfy.transcript }}
        </div>
    </div>

    <!-- Status indicator -->
    <div class="mb-6 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
        <div class="flex items-center">
            <span class="text-yellow-600 text-xl mr-2">&#9203;</span>
            <span class="text-yellow-800">Pending approval</span>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="space-y-3">
        <form action="/inventory/approve_shelfy_form" method="POST">
            <input type="hidden" name="shelfy_id" value="{{ shelfy.shelfy_id }}">
            <button type="submit"
                    class="w-full p-4 bg-mise-red hover:bg-mise-red-dark rounded-xl text-white font-semibold
                           transition-all duration-200 active:scale-98 mise-btn-primary">
                Approve & Save
            </button>
        </form>

        <a href="/inventory/record/{{ shelfy.category }}/{{ shelfy.area | lower | replace(' ', '-') }}"
           class="block w-full p-4 bg-white border-2 border-mise-red/20 hover:border-mise-red rounded-xl
                  text-center text-mise-navy font-medium transition-all duration-200">
            Re-record
        </a>

        <a href="/inventory"
           class="block w-full p-3 text-center text-mise-navy/50 hover:text-mise-navy text-sm">
            Cancel
        </a>
    </div>
</div>

<script>
async function acceptMatch(itemIndex, shelfyId, productName) {
    const itemEl = document.getElementById('item-' + itemIndex);
    const reviewPanel = itemEl.querySelector('.review-panel');
    const questionMark = itemEl.querySelector('.text-yellow-600');

    try {
        // Call API to accept the match
        const response = await fetch('/inventory/accept_match', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                shelfy_id: shelfyId,
                item_index: itemIndex,
                accepted_name: productName
            })
        });

        if (response.ok) {
            // Hide the review panel
            if (reviewPanel) {
                reviewPanel.style.display = 'none';
            }
            // Remove the question mark
            if (questionMark) {
                questionMark.remove();
            }
            // Change background to green
            itemEl.classList.remove('bg-yellow-50', 'border', 'border-yellow-300');
            itemEl.classList.add('bg-green-50');

            // Add a checkmark indicator
            const productNameEl = itemEl.querySelector('.item-product-name');
            if (productNameEl && !productNameEl.querySelector('.matched-check')) {
                const check = document.createElement('span');
                check.className = 'text-green-600 ml-2 matched-check';
                check.textContent = '‚úì';
                productNameEl.appendChild(check);
            }
        } else {
            alert('Failed to save match. Please try again.');
        }
    } catch (error) {
        console.error('Error accepting match:', error);
        alert('Error saving match. Please try again.');
    }
}
</script>
{% endblock %}
