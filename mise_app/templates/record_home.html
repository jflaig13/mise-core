{% extends "base_payroll.html" %}

{% block title %}Record a Shifty{% endblock %}

{% block content %}
<div class="p-4 flex flex-col items-center justify-center min-h-[70vh]">
    <!-- What's a shifty? -->
    <div class="mb-6 mise-card mise-accent-left-green px-4 py-3 max-w-sm">
        <p class="text-xs text-mise-navy/50 leading-relaxed text-center">
            A <em>shifty</em> = one shift's payroll data: date, AM/PM, support staff, servers, tips &amp; food sales.<br>
            7 days &times; 2 shifts = 14 shifties per week.
        </p>
    </div>

    <!-- Recording UI -->
    <div id="recorder" class="text-center w-full flex flex-col items-center">
        <!-- Tappable Audiowave Logo -->
        <button id="record-btn"
                class="mise-breathe w-40 h-40 rounded-full bg-mise-green hover:bg-mise-green-dark flex items-center justify-center
                       transition-all duration-200 active:scale-95 shadow-lg"
                onclick="toggleRecording()">
            <svg id="audiowave-icon" class="w-20 h-20" viewBox="0 0 24 24" fill="white">
                <rect x="1" y="10" width="2.5" height="4" rx="1.25"/>
                <rect x="5.75" y="6" width="2.5" height="12" rx="1.25"/>
                <rect x="10.5" y="2" width="2.5" height="20" rx="1.25"/>
                <rect x="15.25" y="6" width="2.5" height="12" rx="1.25"/>
                <rect x="20" y="10" width="2.5" height="4" rx="1.25"/>
            </svg>
            <span id="btn-text" class="hidden text-white text-lg font-semibold">Tap to<br>Stop</span>
        </button>

        <p id="status" class="mt-6 text-mise-navy/60 text-lg">Tap to record a shifty</p>
        <p class="mt-1 mise-tagline" id="encouragement">Just talk like you're telling a coworker.</p>
        <p id="timer" class="mt-2 text-2xl font-mono text-mise-navy/50 hidden">00:00</p>
    </div>

    <!-- Remember section -->
    <div class="mt-8 text-center px-4 max-w-sm">
        <p class="text-mise-navy/50 text-sm leading-relaxed">
            <span class="italic">Remember:</span> Date &rarr; AM or PM &rarr; Support Staff Roles, First Names &rarr; Server First Name &rarr; Total Tips &rarr; Total Food Sales
        </p>
        <div class="mt-4 space-y-3 text-left">
            <details class="group">
                <summary class="text-mise-green text-sm cursor-pointer list-none flex items-center">
                    <span class="mr-1 transition-transform group-open:rotate-90">&#9658;</span>
                    Support staff owed partial tipout?
                </summary>
                <div class="mt-2 ml-4 text-xs text-mise-navy/60 space-y-2">
                    <p><strong>Here's what to do:</strong> Explain how many hours each employee did NOT work, after you say the last support staff first name.</p>
                    <p><strong>Example:</strong> "AM shift. Utility was Ryan. He took a 2 hour break."</p>
                    <p><strong>Or:</strong> "PM shift. Expo was Ryan. Busser was John. John left 2.5 hours before end of closing, which was 10:17PM. Ryan came in an hour late."</p>
                    <p><strong>PM shifts:</strong> Include "End of Closing" — the approximate time servers clocked out after close.</p>
                    <p><strong>AM shifts:</strong> Always 10AM–4:30PM, no action needed.</p>
                    <p class="text-red-600/80 mt-2"><strong>Warning:</strong> Partial tipouts must be based on actual hours worked or discussed directly between manager and support staff. Reporting a lower tipout than earned — without the support staff's and manager's knowledge — is grounds for immediate termination.</p>
                </div>
            </details>
            <details class="group">
                <summary class="text-mise-green text-sm cursor-pointer list-none flex items-center">
                    <span class="mr-1 transition-transform group-open:rotate-90">&#9658;</span>
                    Unequal hours in tip pool?
                </summary>
                <div class="mt-2 ml-4 text-xs text-mise-navy/60">
                    <p><strong>Here's what to do:</strong> After the last server's food sales, add &rarr; Server 1 First Name &rarr; Server 1 # Hours in Tip Pool &rarr; Server 2 First Name &rarr; Server 2 # Hours in Tip Pool etc. As always, speak naturally!</p>
                </div>
            </details>
        </div>
    </div>

    <!-- Or upload -->
    <div class="mt-8 text-center">
        <div class="relative inline-block">
            <p class="text-mise-navy/40 mb-3 text-sm">or upload a recording</p>
            <label class="inline-block px-5 py-3 mise-card hover:border-mise-green/30 rounded-xl cursor-pointer transition-all border-2 border-dashed border-mise-navy/15">
                <span class="text-sm text-mise-navy/60">Choose File</span>
                <input type="file" accept="audio/*,.wav,.m4a,.mp3"
                       class="hidden" onchange="uploadFile(this)">
            </label>
        </div>
    </div>

    <!-- Processing overlay -->
    <div id="processing-overlay" class="hidden fixed inset-0 bg-mise-cream/90 mise-overlay flex items-center justify-center z-50">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-xl font-semibold mb-2">Processing...</p>
            <p class="text-mise-navy/60" id="processing-status">Transcribing audio</p>
        </div>
    </div>

    <!-- Error message -->
    <div id="error-message" class="hidden fixed bottom-24 left-4 right-4 p-4 bg-red-100 border border-red-300 rounded-lg z-40">
        <p class="text-red-600" id="error-text"></p>
        <button onclick="document.getElementById('error-message').classList.add('hidden')"
                class="mt-2 text-sm text-mise-navy/60 hover:text-mise-navy">Dismiss</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let mediaRecorder;
let chunks = [];
let timerInterval;
let seconds = 0;

function updateTimer() {
    seconds++;
    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
    const secs = (seconds % 60).toString().padStart(2, '0');
    document.getElementById('timer').textContent = `${mins}:${secs}`;
}

async function toggleRecording() {
    const btn = document.getElementById('record-btn');
    const btnText = document.getElementById('btn-text');
    const audiowaveIcon = document.getElementById('audiowave-icon');
    const status = document.getElementById('status');
    const timer = document.getElementById('timer');

    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        // Start recording
        try {
            const stream = await navigator.mediaDevices.getUserMedia({audio: true});

            // Check if we got audio tracks
            const audioTracks = stream.getAudioTracks();
            console.log('Audio tracks:', audioTracks.length, audioTracks);
            if (audioTracks.length === 0) {
                showError('No microphone detected. Please check your device settings.');
                return;
            }

            // Check track state
            const track = audioTracks[0];
            console.log('Track state:', track.readyState, 'enabled:', track.enabled, 'muted:', track.muted);

            // Determine best mime type for this browser
            let mimeType = 'audio/webm';
            if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                mimeType = 'audio/webm;codecs=opus';
            } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                mimeType = 'audio/mp4';
            } else if (MediaRecorder.isTypeSupported('audio/wav')) {
                mimeType = 'audio/wav';
            }
            console.log('Using mime type:', mimeType);

            mediaRecorder = new MediaRecorder(stream, { mimeType });
            chunks = [];

            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                console.log('Recording stopped. Chunks:', chunks.length);
                if (chunks.length === 0) {
                    showError('No audio data captured. Please check microphone permissions and try again.');
                    resetRecordButton();
                    return;
                }
                const blob = new Blob(chunks, {type: mimeType});
                console.log('Blob size:', blob.size);
                if (blob.size === 0) {
                    showError('Empty recording. Please try again.');
                    resetRecordButton();
                    return;
                }
                submitAudio(blob);
            };

            mediaRecorder.onerror = (e) => {
                console.error('MediaRecorder error:', e);
                showError('Recording error: ' + (e.error ? e.error.message : 'Unknown error'));
                resetRecordButton();
            };

            // Show countdown before starting to record
            btn.classList.remove('mise-breathe');
            btn.classList.add('recording');
            btn.classList.remove('bg-mise-green');
            btn.classList.add('bg-red-500');
            audiowaveIcon.classList.add('hidden');
            btnText.classList.remove('hidden');

            // 3 second countdown
            for (let i = 3; i > 0; i--) {
                btnText.innerHTML = i.toString();
                status.textContent = `Starting in ${i}...`;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            // NOW start recording
            mediaRecorder.start();

            btnText.innerHTML = 'Tap to<br>Stop';
            status.textContent = 'Recording...';
            timer.classList.remove('hidden');
            seconds = 0;
            timerInterval = setInterval(updateTimer, 1000);

        } catch (err) {
            showError('Microphone access denied. Please allow microphone access and try again.');
        }
    } else {
        // Stop recording - check minimum time
        if (seconds < 2) {
            showError('Recording too short. Please record for at least 2 seconds.');
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            resetRecordButton();
            return;
        }
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        btn.classList.remove('recording', 'bg-red-500');
        btn.classList.add('bg-mise-green');
        audiowaveIcon.classList.remove('hidden');
        btnText.classList.add('hidden');
        status.textContent = 'Processing...';
        clearInterval(timerInterval);
    }
}

function uploadFile(input) {
    if (input.files[0]) {
        const file = input.files[0];
        document.getElementById('status').textContent = `Uploading ${file.name}...`;
        submitAudio(file);
    }
}

async function submitAudio(audioBlob) {
    const overlay = document.getElementById('processing-overlay');
    const processingStatus = document.getElementById('processing-status');

    overlay.classList.remove('hidden');
    processingStatus.textContent = 'Uploading audio...';

    const formData = new FormData();
    formData.append('file', audioBlob, 'recording.webm');

    try {
        processingStatus.textContent = 'Transcribing audio...';

        const response = await fetch('/payroll/period/{{ period.id }}/process', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.status === 'success') {
            processingStatus.textContent = 'Opening approval page...';

            if (result.redirect_url) {
                window.location.href = result.redirect_url;
            } else {
                window.location.href = '/payroll/period/{{ period.id }}/shifties';
            }
        } else {
            overlay.classList.add('hidden');
            showError(result.error || 'Processing failed');
            resetRecordButton();
        }

    } catch (err) {
        overlay.classList.add('hidden');
        showError('Network error: ' + err.message);
        resetRecordButton();
    }
}

function showError(message) {
    const errorDiv = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    errorText.textContent = message;
    errorDiv.classList.remove('hidden');
}

function resetRecordButton() {
    const btn = document.getElementById('record-btn');
    const btnText = document.getElementById('btn-text');
    const audiowaveIcon = document.getElementById('audiowave-icon');
    const status = document.getElementById('status');
    const timer = document.getElementById('timer');

    btn.classList.remove('recording', 'bg-red-500');
    btn.classList.add('bg-mise-green', 'mise-breathe');
    audiowaveIcon.classList.remove('hidden');
    btnText.classList.add('hidden');
    status.textContent = 'Tap to record a shifty';
    timer.classList.add('hidden');
    clearInterval(timerInterval);
}
</script>
{% endblock %}
