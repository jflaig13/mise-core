# MISE SWARM WORKFLOW MASTER SPECIFICATION
Version: 1.0
Last Updated: 2026-01-20
Domain: swarm

================================================================================
## PURPOSE
================================================================================

The Mise Swarm is a multi-window task management system for Claude Code that
enables parallel execution of complex, multi-step development tasks.

**Core Function:**
- Coordinate multiple Claude Code windows working simultaneously
- Queue and prioritize development tasks across windows
- Archive completed work for audit trail and context
- Enable fast iteration on Mise development without blocking

**Key Principles:**
1. File-based task queue (no database, no external services)
2. Each window operates independently with its own command queue
3. Tasks are executed sequentially within each window
4. Completed tasks are archived, not deleted (full audit trail)

================================================================================
## ARCHITECTURE
================================================================================

### Directory Structure

```
~/mise-core/claude_commands/
├── ccw1/                    # Claude Code Window 1 (Primary - also called ccqb)
│   ├── archive/             # Completed ccw1 tasks
│   └── *.md                 # Pending ccw1 tasks
├── ccw2/                    # Claude Code Window 2
│   ├── archive/             # Completed ccw2 tasks
│   └── *.md                 # Pending ccw2 tasks
├── ccw3/                    # Claude Code Window 3
│   ├── archive/             # Completed ccw3 tasks
│   └── *.md                 # Pending ccw3 tasks
├── ccw4/                    # Claude Code Window 4
│   ├── archive/             # Completed ccw4 tasks
│   └── *.md                 # Pending ccw4 tasks
├── ccw5/                    # Claude Code Window 5
│   ├── archive/             # Completed ccw5 tasks
│   └── *.md                 # Pending ccw5 tasks
└── ccw6/                    # Claude Code Window 6
    ├── archive/             # Completed ccw6 tasks
    └── *.md                 # Pending ccw6 tasks
```

**Note:** "ccqb" and "ccw1" refer to the same directory (ccw1/). The alias "ccqb"
(Command Queue Board) is sometimes used to refer to ccw1 in conversation.

### Window Assignment

- **ccw1 (ccqb)**: Primary window - general development, features, refactoring
- **ccw2**: Testing and validation window
- **ccw3**: Documentation and specs window
- **ccw4**: Deployment and infrastructure window
- **ccw5**: Bug fixes and hotfixes window
- **ccw6**: Research and exploration window

**Note:** Window assignments are guidelines. Tasks can go to any window based
on availability and workload.

================================================================================
## COMMAND QUEUE PROTOCOL
================================================================================

### Task Creation

**When user says:** "Run the [command_name] command" or "Run the ccw1 command" or "Run the ccqb command"

**Claude Code must:**
1. Find all new files in the appropriate ccw folder (e.g., ~/mise-core/claude_commands/ccw1/)
2. Read files in sequential order (alphabetically by filename)
3. Execute the contents of each file in the order they were saved
4. Move completed command files to the window's archive/ folder
5. Report results for each command executed

**Note:** "ccqb command" and "ccw1 command" are equivalent - both refer to ccw1/

**File Naming Convention:**
- Use descriptive names: `deploy_all.md`, `fix_name_bug.md`, `update_docs.md`
- Can use numbered prefixes for explicit ordering: `1_setup.md`, `2_configure.md`
- Must use `.md` extension (allows rich formatting in task descriptions)

### Task Execution Flow

```
User drops task → ccw folder
         ↓
Claude detects on "run the [ccw] command"
         ↓
Read all .md files (sequential, alphabetical)
         ↓
Execute each file's contents in order
         ↓
Move completed file → archive/
         ↓
Report completion status
```

### Task File Format

Each task file should contain:
1. **Header**: Brief description of task
2. **Context**: Why this task is needed
3. **Commands/Actions**: What Claude should execute
4. **Success Criteria**: How to verify completion

**Example Task File (ccw1/deploy_fixes.md):**
```markdown
# Deploy Name Normalization Fixes

## Context
Mark name bug causing hallucinations. Fixed in payroll_prompt.py, need to deploy.

## Actions
1. Build and deploy transrouter with gcloud run deploy --source .
2. Switch traffic to new revision
3. Test with "Mark" in transcript → should output "Mark Buryanek"

## Success Criteria
- Deployment completes without errors
- Traffic switched to new revision (100%)
- Test confirms correct name normalization
```

================================================================================
## ARCHIVE SYSTEM
================================================================================

### Purpose
- Maintain full audit trail of all tasks completed
- Enable context recovery for debugging
- Track what was done and when
- Prevent accidental re-execution of completed tasks

### Archive Rules
1. **Never delete task files** - always move to archive/
2. **Preserve original filenames** - no renaming in archive
3. **Archive immediately after completion** - don't batch
4. **Include timestamp in move** - use `mv` with verbose output to log time

### Archive Organization
- Files in archive/ keep their original names
- Most recent files appear at top of `ls -lt archive/` output
- If duplicate filename exists, append timestamp: `task_20260120_1534.md`

================================================================================
## WINDOW-SPECIFIC PROTOCOLS
================================================================================

### ccw1 (Primary Window, also called "ccqb")

**Purpose:** Primary development window and task intake

**User Pattern:**
- User says "run the ccw1 command" or "run the ccqb command" (equivalent)
- Claude reads all tasks in ccw1/ folder
- Claude executes each task sequentially
- Claude moves completed tasks to ccw1/archive/

**Note:** ccw1 is the primary window and handles general development tasks. The
"ccqb" alias is sometimes used in conversation but refers to the same ccw1/ directory.

### ccw2-6 (Worker Windows)

**Purpose:** Execute tasks assigned to each specialized window

**User Pattern:**
- User says "run the ccw1 command" (or ccw2, ccw3, etc.)
- Claude reads all tasks in that ccw folder
- Claude executes each task sequentially
- Claude moves completed tasks to archive/

**Execution Logic:**
1. List all .md files in ccw folder (excluding archive/)
2. Sort alphabetically (or by numeric prefix if present)
3. For each file:
   a. Read contents
   b. Execute commands/actions described
   c. Verify success criteria
   d. Move to archive/
   e. Report status
4. Report summary when all tasks complete

================================================================================
## SWARM COORDINATION
================================================================================

### Parallel Execution
- Multiple ccw windows can run simultaneously (user opens multiple Claude Code instances)
- Each window is independent - no shared state
- Tasks should be designed to avoid conflicts (e.g., don't modify same file in ccw1 and ccw2)

### Task Dependencies
- If Task B depends on Task A, put them in same ccw folder (sequential execution guaranteed)
- If tasks are independent, distribute to different ccw folders (parallel execution possible)

### Conflict Resolution
- If multiple tasks modify the same file, they must be in same ccw (sequential)
- User is responsible for task distribution to avoid conflicts
- Claude should flag potential conflicts if detected during execution

================================================================================
## SAFETY & ERROR HANDLING
================================================================================

### Pre-Execution Checks
Before executing any task:
1. Verify task file is well-formed and readable
2. Check for obvious conflicts (e.g., file being edited doesn't exist)
3. Confirm any destructive operations with user

### During Execution
1. Execute one command at a time
2. Check success of each command before proceeding
3. If command fails, STOP and report - do not continue
4. Log all outputs for debugging

### Post-Execution
1. Verify success criteria from task file
2. Only move to archive if task fully completed
3. If partial completion, leave in ccw folder with status comment
4. Report any warnings or anomalies

### Error Protocol
If a task fails:
1. **Stop immediately** - do not continue to next task
2. **Report error details** - command that failed, error message, context
3. **Leave task in ccw folder** - do not archive incomplete work
4. **Create error report** - document what happened for debugging
5. **Wait for user** - do not attempt to fix unless instructed

================================================================================
## MONITORING & REPORTING
================================================================================

### Status Queries

User can ask:
- "What's in the ccw1 queue?" → Claude lists pending tasks in ccw1/
- "What did ccw2 complete?" → Claude lists recent files in ccw2/archive/
- "Show me the last ccqb task" → Claude reads most recent ccqb/archive/ file

### Progress Tracking
- Use TodoWrite tool to track multi-step tasks within a command
- Report progress after each file execution
- Summarize at end: "Completed 3/3 tasks in ccw1, all archived"

### Audit Trail
All completed tasks preserved in archive/ folders:
```bash
# View what ccw1 has done recently
ls -lt ~/mise-core/claude_commands/ccw1/archive/ | head -10

# Read a completed task
cat ~/mise-core/claude_commands/ccw1/archive/deploy_fixes.md
```

================================================================================
## INTEGRATION WITH MISE ECOSYSTEM
================================================================================

### Relationship to Other Workflows
- **LPM/CPM**: Swarm can distribute payroll development tasks to ccw windows
- **LIM**: Swarm can coordinate inventory feature development
- **Transrouter**: Swarm manages transrouter deployments and API changes
- **Brain Sync**: Swarm updates are tracked like other workflow changes

### Brain Integration
- Swarm workflow master lives in workflow_specs/SWARM/
- Changes tracked in workflow_specs/SWARM/workflow_changes/
- brain_sync.py loads Swarm spec alongside LPM, CPM, LIM, Transrouter

### Documentation Requirements
- All Swarm changes must be documented in workflow_changes/
- Breaking changes to command queue protocol require version bump
- New window types (ccw7+) require update to this master spec

================================================================================
## EXAMPLES
================================================================================

### Example 1: Simple Single-Window Task

**User creates:** `ccw1/fix_typo.md`
```markdown
# Fix Typo in README

## Context
User reported "Mise Swarm" misspelled as "Mise Swram" in README.md

## Actions
1. Read ~/mise-core/README.md
2. Find and fix typo: "Swram" → "Swarm"
3. Verify no other instances of misspelling

## Success Criteria
- README.md contains "Mise Swarm" (correct spelling)
- No instances of "Swram" remain
```

**User says:** "Run the ccw1 command"

**Claude does:**
1. Reads ccw1/fix_typo.md
2. Executes: Read README.md → Edit to fix typo → Grep for "Swram"
3. Verifies success criteria met
4. Moves ccw1/fix_typo.md → ccw1/archive/
5. Reports: "✓ Completed fix_typo.md - typo fixed, no other instances found"

### Example 2: Multi-File Sequential Task

**User creates:**
- `ccw2/1_write_tests.md`
- `ccw2/2_run_tests.md`
- `ccw2/3_fix_failures.md`

**User says:** "Run the ccw2 command"

**Claude does:**
1. Reads ccw2/1_write_tests.md → writes test files → archives
2. Reads ccw2/2_run_tests.md → runs pytest → archives
3. Reads ccw2/3_fix_failures.md → fixes failing tests → archives
4. Reports summary: "✓ Completed 3/3 tasks in ccw2"

### Example 3: Deployment Task

**User creates:** `ccw4/deploy_hotfix.md`
```markdown
# Hotfix: Deploy Name Normalization Fix

## Context
Production bug in name normalization. Fixes ready in payroll_prompt.py.

## Actions
1. Build transrouter with gcloud run deploy --source .
2. Switch traffic to new revision
3. Monitor logs for 5 minutes
4. Test name normalization with sample input

## Success Criteria
- Deployment successful
- Traffic at 100% on new revision
- No errors in logs
- Name normalization test passes
```

**User says:** "Run the ccw4 command"

**Claude does:**
1. Reads ccw4/deploy_hotfix.md
2. Executes deployment, traffic switch, monitoring, testing
3. Verifies all success criteria met
4. Moves ccw4/deploy_hotfix.md → ccw4/archive/
5. Reports: "✓ Hotfix deployed and verified"

================================================================================
## VERSION HISTORY
================================================================================

### v1.0 (2026-01-20)
- Initial Swarm workflow specification
- Defined ccqb + ccw1-6 architecture
- Established command queue protocol
- Created archive system
- Integrated with Mise brain_sync.py

================================================================================
## REFERENCES
================================================================================

- Mise Core Principles: VALUES_CORE.md
- Agent Safety Policy: AGENT_POLICY.md
- Brain System Documentation: docs/brain/
- Other Workflows: workflow_specs/LPM/, workflow_specs/CPM/, workflow_specs/LIM/
- Claude Code Instructions: CLAUDE.md

================================================================================
## MAINTAINER
================================================================================

This workflow is maintained by the Mise development team.
Changes must be documented in workflow_specs/SWARM/workflow_changes/

For questions or proposed changes, consult:
- Primary Axiom (VALUES_CORE.md) for philosophical guidance
- AGENT_POLICY.md for safety boundaries
- Existing workflow patterns in LPM/CPM/LIM for structural precedent

================================================================================
END OF SWARM WORKFLOW MASTER SPECIFICATION
================================================================================
